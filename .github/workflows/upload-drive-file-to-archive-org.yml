name: 📥 Upload Google Drive File to Archive.org

on:
  workflow_dispatch:
    inputs:
      google_drive_url:
        description: 'Public Google Drive File URL'
        required: true
        type: string
      archive_org_item:
        description: 'Archive.org Item Identifier (e.g., my-cool-item)'
        required: true
        type: string
      output_filename:
        description: 'Filename to save as (e.g., video.mp4)'
        required: true
        type: string

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: ⚙️ Install rclone
        run: |
          sudo -v ; curl https://rclone.org/install.sh | sudo bash

      - name: 🔐 Configure rclone for Archive.org
        env:
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
        run: |
          mkdir -p ~/.config/rclone
          printf "[archive]\ntype = s3\nprovider = Other\nenv_auth = false\naccess_key_id = %s\nsecret_access_key = %s\nendpoint = s3.us.archive.org\n" "$IA_ACCESS_KEY" "$IA_SECRET_KEY" > ~/.config/rclone/rclone.conf

      - name: 🔗 Extract Google Drive File ID
        id: gdrive
        run: |
          FILE_ID=$(echo "${{ github.event.inputs.google_drive_url }}" | sed -n 's/.*\/d\/\(.*\)\/view.*/\1/p')
          echo "id=$FILE_ID" >> $GITHUB_OUTPUT

      - name: 📥 Download file from Google Drive
        run: |
          curl -L -o "${{ github.event.inputs.output_filename }}" "https://drive.google.com/uc?export=download&id=${{ steps.gdrive.outputs.id }}"

      - name: 📤 Upload file to Archive.org
        run: |
          rclone copy "${{ github.event.inputs.output_filename }}" "archive:${{ github.event.inputs.archive_org_item }}/" --progress