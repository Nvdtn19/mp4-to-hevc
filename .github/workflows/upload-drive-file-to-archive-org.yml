name: Upload Google Drive File to Archive.org

on:
  workflow_dispatch:
    inputs:
      gdrive_url:
        description: 'Public Google Drive File URL'
        required: true
        default: 'https://drive.google.com/file/d/16BaTIoMU4-oCAwPW4P0r-GB1ucVznZyA/view?usp=drive_link'
      output_filename:
        description: 'Name for the downloaded file'
        required: true
        default: 'downloaded_file'
      archive_title:
        description: 'Title for the Archive.org item'
        required: true
        default: 'My Uploaded File'
      archive_page_url_id:
        description: 'Archive.org Page URL ID (optional, auto-generated if empty)'
        required: false
      archive_description:
        description: 'Description for the Archive.org item'
        required: false
        default: 'This file was uploaded from Google Drive via a GitHub Action.'
      archive_subject_tags:
        description: 'Subject tags for the Archive.org item (comma-separated)'
        required: false
        default: 'github,automation,rclone'
      archive_collection:
        description: 'Archive.org collection mediatype (e.g., data, texts, movies)'
        required: true
        default: 'data'
      is_test_item:
        description: 'Is this a test item? (true/false)'
        required: true
        default: 'true'

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Latest Rclone
        run: |
          curl -L -o rclone.deb https://downloads.rclone.org/rclone-current-linux-amd64.deb
          sudo dpkg -i rclone.deb

      - name: Decode rclone.conf from secret
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONF }}" | base64 --decode > ~/.config/rclone/rclone.conf

      - name: Extract Google Drive File ID
        id: get_gdrive_id
        run: |
          echo "file_id=$(echo "${{ github.event.inputs.gdrive_url }}" | grep -oP '(?<=/d/|id=)[^/&?]+')" >> $GITHUB_OUTPUT

      - name: Download file from Google Drive
        run: |
          echo "--- Verifying rclone before download ---"
          echo "Location of rclone executable:"
          which rclone
          echo "Version of rclone being used:"
          rclone version
          echo "----------------------------------------"
          
          echo "Starting download..."
          rclone copyto "gdrive:${{ steps.get_gdrive_id.outputs.file_id }}" \
            "./${{ github.event.inputs.output_filename }}" \
            --drive-acknowledge-abuse \
            -v \
            --drive-server-side-across-all-drives
          echo "File downloaded."

      - name: Upload file to Archive.org
        run: |
          if [ -z "${{ github.event.inputs.archive_page_url_id }}" ]; then
            PAGE_URL_ID=$(echo "${{ github.event.inputs.archive_title }}-${{ github.run_id }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          else
            PAGE_URL_ID="${{ github.event.inputs.archive_page_url_id }}"
          fi

          rclone copyto "./${{ github.event.inputs.output_filename }}" \
            "archive:${PAGE_URL_ID}/${{ github.event.inputs.output_filename }}" \
            --metadata-set "title=${{ github.event.inputs.archive_title }}" \
            --metadata-set "description=${{ github.event.inputs.archive_description }}" \
            --metadata-set "subject=${{ github.event.inputs.archive_subject_tags }}" \
            --metadata-set "collection=test_collection" \
            --metadata-set "mediatype=${{ github.event.inputs.archive_collection }}" \
            -v \
            --header-upload "x-archive-test-item:${{ github.event.inputs.is_test_item }}"