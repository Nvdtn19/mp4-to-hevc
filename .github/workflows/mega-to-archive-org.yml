# This GitHub Action downloads files/folders from a public MEGA link
# and uploads them to Archive.org with detailed metadata.

# To use this:
# 1. Place this file in your GitHub repository at: .github/workflows/upload_to_archive.yml
# 2. Add your Archive.org keys as secrets in your repository's settings:
#    - IA_ACCESS_KEY: Your S3-style Access Key.
#    - IA_SECRET_KEY: Your S3-style Secret Key.
# 3. Go to the "Actions" tab in your repository, select this workflow,
#    and click "Run workflow" to start.

name: Mega to Archive.org Uploader

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      mega_link:
        description: 'Public MEGA Folder or File Link'
        required: true
      archive_identifier:
        description: 'Item ID (Optional). If blank, a unique ID will be generated from the title.'
        required: false
      archive_title:
        description: 'Page Title'
        required: true
      archive_collection:
        description: 'Select the Archive.org Collection'
        type: choice
        required: true
        options:
          - 'Data'
          - 'Texts'
          - 'Audio'
          - 'Movies'
          - 'Software'
          - 'Image'
          - 'Community'
      archive_license:
        description: 'Select the License'
        type: choice
        required: true
        options:
          - 'CC0 - No Rights Reserved'
          - 'Creative Commons: Attribution 4.0'
          - 'Creative Commons: Attribution-ShareAlike 4.0'
          - 'Creative Commons: Attribution-NonCommercial 4.0'
          - 'Creative Commons: Attribution-NonCommercial-ShareAlike 4.0'
          - 'Public Domain Mark 1.0'
          - 'Leave license blank'
      test_item:
        description: 'Is this a test item?'
        type: choice
        required: true
        options:
          - 'No'
          - 'Yes'
      archive_description:
        description: 'Item Description'
        required: false
      archive_subjects:
        description: 'Subject Tags (comma-separated)'
        required: false
      archive_creator:
        description: 'Content Creator'
        required: false
      archive_date:
        description: 'Publish Date (YYYY-MM-DD)'
        required: false

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install and Download from MEGA
        run: |
          # --- Installation ---
          echo "Installing MEGAcmd..."
          sudo apt-get update
          sudo apt-get install -y curl gpg lsb-release
          curl -fsSL https://mega.nz/keys/MEGA_signing.key | sudo gpg --dearmor -o /usr/share/keyrings/mega-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/mega-archive-keyring.gpg] https://mega.nz/linux/repo/xUbuntu_$(lsb_release -rs)/ ./" | sudo tee /etc/apt/sources.list.d/mega.list
          sudo apt-get update
          sudo apt-get install -y megacmd
          echo "Installation complete."

          # --- Download ---
          echo "Starting download from MEGA..."
          mkdir ./download_content
          megacmd get "${{ github.event.inputs.mega_link }}" ./download_content
          echo "Download complete."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Internet Archive Client
        run: pip install internetarchive

      - name: Set Current Date if Not Provided
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Build Upload Command
        id: build_command
        run: |
          # Step 1: Determine the final item identifier.
          IDENTIFIER="${{ github.event.inputs.archive_identifier }}"
          if [ -z "$IDENTIFIER" ]; then
            echo "No Item ID provided, generating a new one..."
            SANITIZED_TITLE=$(echo "${{ github.event.inputs.archive_title }}" | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-z0-9]/-/g' -e 's/--*//g' -e 's/^-//' -e 's/-$//')
            TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
            IDENTIFIER="${SANITIZED_TITLE:-item}-${TIMESTAMP}"
          fi
          echo "Final Item ID: $IDENTIFIER"
          echo "final_identifier=$IDENTIFIER" >> $GITHUB_OUTPUT

          # Step 2: Map the user-friendly collection name to the correct technical ID.
          COLLECTION_INPUT="${{ github.event.inputs.archive_collection }}"
          TARGET_COLLECTION=""
          case "$COLLECTION_INPUT" in
            "Data" | "Texts")
              TARGET_COLLECTION="opensource_media"
              ;;
            "Movies")
              TARGET_COLLECTION="opensource_movies"
              ;;
            "Audio")
              TARGET_COLLECTION="opensource_audio"
              ;;
            "Software")
              TARGET_COLLECTION="opensource_software"
              ;;
            "Image")
              TARGET_COLLECTION="opensource_images"
              ;;
            *)
              # Default case for "Community" or any other value
              TARGET_COLLECTION="opensource_media"
              ;;
          esac
          echo "Input Collection: '$COLLECTION_INPUT' -> Mapped to: '$TARGET_COLLECTION'"

          # Step 3: Build the full `ia upload` command with all metadata.
          CMD="ia upload '$IDENTIFIER' ./download_content/*"
          CMD="$CMD --metadata=\"title:${{ github.event.inputs.archive_title }}\""
          CMD="$CMD --metadata=\"collection:$TARGET_COLLECTION\""
          CMD="$CMD --metadata=\"description:${{ github.event.inputs.archive_description }}\""
          CMD="$CMD --metadata=\"subject:${{ github.event.inputs.archive_subjects }}\""
          CMD="$CMD --metadata=\"creator:${{ github.event.inputs.archive_creator }}\""
          DATE="${{ github.event.inputs.archive_date || steps.date.outputs.date }}"
          CMD="$CMD --metadata=\"date:$DATE\""
          if [ "${{ github.event.inputs.test_item }}" == "Yes" ]; then
            CMD="$CMD --metadata=\"test-item:yes\""
          fi
          LICENSE_URL=""
          case "${{ github.event.inputs.archive_license }}" in
            "CC0 - No Rights Reserved") LICENSE_URL="http://creativecommons.org/publicdomain/zero/1.0/" ;;
            "Creative Commons: Attribution 4.0") LICENSE_URL="http://creativecommons.org/licenses/by/4.0/" ;;
            "Creative Commons: Attribution-ShareAlike 4.0") LICENSE_URL="http://creativecommons.org/licenses/by-sa/4.0/" ;;
            "Creative Commons: Attribution-NonCommercial 4.0") LICENSE_URL="http://creativecommons.org/licenses/by-nc/4.0/" ;;
            "Creative Commons: Attribution-NonCommercial-ShareAlike 4.0") LICENSE_URL="http://creativecommons.org/licenses/by-nc-sa/4.0/" ;;
            "Public Domain Mark 1.0") LICENSE_URL="http://creativecommons.org/publicdomain/mark/1.0/" ;;
          esac
          if [ -n "$LICENSE_URL" ]; then
            CMD="$CMD --metadata=\"licenseurl:$LICENSE_URL\""
          fi
          
          echo "#!/bin/bash" > ./upload_script.sh
          echo "$CMD" >> ./upload_script.sh
          chmod +x ./upload_script.sh

      - name: Upload Content to Archive.org
        env:
          # Authenticate using the secrets stored in the repository settings.
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
        run: |
          echo "The following command will be executed:"
          cat ./upload_script.sh
          echo "---"
          ./upload_script.sh

      - name: âœ… All Done!
        run: |
          echo "Upload complete!"
          # Use the output from the build step to get the correct final ID for the link.
          echo "Access your item at: https://archive.org/details/${{ steps.build_command.outputs.final_identifier }}"
